#!/usr/bin/env php
<?php
use Phalcon\Logger;
use Phalcon\Logger\Adapter\Stream as ConsoleAppender;
use Phalcon\Logger\Formatter\Line as LineFormatter;
use Phalcon\Di\FactoryDefault;
use PhalconX\Cli\Application;
use PhalconX\Cli\Router;
use PhalconX\Annotations\Cli\Option;

$loader = require(__DIR__.'/../vendor/autoload.php');
$loader->add('PhalconX', __DIR__.'/../tests');

$di = new FactoryDefault;
$di['logger'] = function() {
    $formatter = new LineFormatter("%date% [%type%] %message%\n");
    $logger = new ConsoleAppender('php://stderr');
    $logger->setFormatter($formatter);
    $logger->setLogLevel(Logger::INFO);
    return $logger;
};
$di['router'] = function() {
    $router = new Router([
        'globalOptions' => [
            new Option([
                'name' => 'force',
                'short' => 'f',
                'optional' => true,
                'help' => 'Do not use cache'
            ])
        ]
    ]);
    $router->scan(__DIR__ . '/../tests/PhalconX/Test/Tasks');
    $router->scan(__DIR__ . '/../tests/PhalconX/Test/Tasks2', 't2');
    return $router;
};
$di['reflection'] = 'PhalconX\Util\Reflection';
$di['annotations'] = 'PhalconX\Annotations';

$app = new Application($di);
$app->notFound(function() use ($app) {
        global $argv;
        echo "Cannot found command $argv[1]\n\n";
        $app->handle([$argv[0], "help"]);
        exit(-1);
    });

try {
    // handle incoming arguments
    $app->handle($argv);
} catch (\Exception $e) {
    $di->getLogger()->error($e->getMessage() . "\n" . $e->getTraceAsString());
    exit(-1);
}
