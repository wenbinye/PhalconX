#!/usr/bin/env php
<?php
use Phalcon\Logger;
use Phalcon\Logger\Adapter\Stream as ConsoleAppender;
use Phalcon\Logger\Formatter\Line as LineFormatter;
use Phalcon\Di\FactoryDefault;
use PhalconX\Cli\Application;
use PhalconX\Cli\Router;

$loader = require(__DIR__.'/../vendor/autoload.php');
$loader->add('PhalconX', __DIR__.'/../tests');

$di = new FactoryDefault;
$di['logger'] = function() {
    $formatter = new LineFormatter("%date% [%type%] %message%\n");
    $logger = new ConsoleAppender('php://stderr');
    $logger->setFormatter($formatter);
    $logger->setLogLevel(Logger::INFO);
    return $logger;
};
$di['router'] = function() {
    $router = new Router;
    $router->scan(__DIR__ . '/../tests/PhalconX/Test/Tasks');
    return $router;
};
$di['reflection'] = 'PhalconX\Util\Reflection';

$app = new Application($di);

try {
    // handle incoming arguments
    $app->handle($argv);
} catch (\Exception $e) {
    $di->getLogger()->error($e->getMessage() . "\n" . $e->getTraceAsString());
    exit(-1);
}
