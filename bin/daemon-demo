#!/usr/bin/env php
<?php
use Phalcon\Di;
use Phalcon\Logger;
use Phalcon\Logger\Adapter\File as FileAppender;
use PhalconX\Cli\DaemonOverseer;

$di = require(__DIR__.'/../tests/bootstrap.php');
$di['logger'] = new FileAppender('/tmp/daemon.log');
$di['logger']->setLogLevel(Logger::INFO);

$overseer = new DaemonOverseer([
    'pidfile' => '/tmp/daemon.pid',
    'cwd' => getcwd(),
    'starter' => $argv[0] . ' exec',
    'daemons' => [
        ['PhalconX\Cli\TestDaemon']
    ]
]);
if (isset($argv[1])) {
    if ($argv[1] == 'exec') {
        $stdin = file_get_contents("php://stdin");
        $options = json_decode($stdin);
        if (!is_array($options) || !isset($options[0])) {
            die("Wrong arguments: $stdin");
        }
        $class = $options[0];
        $args = isset($options[1]) ? $options[1] : [];
        $daemon = Di::getDefault()->get($class, [$args]);
        $daemon->run();
    } elseif ($argv[1] == 'stop') {
        $overseer->stop();
    } elseif ($argv[1] == 'status') {
        print_r($overseer->status());
    } elseif ($argv[1] == 'start') {
        $overseer->start();
    }
} else {
    $overseer->start();
}
